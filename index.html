<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Dark Themed Web App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

  <style>
    /* === Global Styles === */
    :root {
      --bg-color: #1e1e1e;
      --fg-color: #f0f0f0;
      --accent-color: #2d2d2d;
      --border-radius: 8px;
      --skeleton-color: #2a2a2a;
      --skeleton-highlight: #3a3a3a;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      outline: none;
      font-family: sans-serif;
    }

    body {
      background-color: var(--bg-color);
      color: var(--fg-color);
      margin: 0;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      /* For DPAD testing, ensure focus ring is visible: */
      /* Outline only on keyboard navigation (optional) */
    }

    button,
    a,
    input {
      color: var(--fg-color);
      background: var(--accent-color);
      border: none;
      border-radius: var(--border-radius);
      padding: 0.5rem 1rem;
      cursor: pointer;
    }

    button:focus,
    [tabindex]:focus {
      /* outline: 2px solid #888; */
      transform: scale(1.3);
      /* Slightly zoom in */
      box-shadow: 0 0 2px rgba(0, 0, 0, 0.5);
      /* Add a subtle elevation effect */
      transition: transform 0.1s ease-in-out, box-shadow 0.1s ease-in-out;
      /* Smooth transition for the effects */
    }




    /* === Container for the entire app === */
    .app-container {
      display: flex;
      flex-direction: column;
      width: 100%;
      max-width: 1200px;
      margin: 0 auto;
    }

    /* === Tabs Bar === */
    .tabs {
      display: flex;
      justify-content: space-between;
      /* Distribute buttons evenly */
      background: var(--accent-color);
      padding: 0.5rem;
      border-radius: var(--border-radius);
      margin: 0.5rem;
      gap: 0.5rem;
    }

    .tab-button {
      flex: 0 0 auto;
      border-radius: var(--border-radius);
      padding: 0.5rem 1rem;
      background: #333;
      color: var(--fg-color);
      border: none;
      cursor: pointer;
    }

    .tab-button.active {
      background: #444;
    }

    /* === Body container for each tab's content === */
    .tab-content {
      flex: 1;
      margin: 0.5rem;
      background: var(--accent-color);
      border-radius: var(--border-radius);
      padding: 1rem;
      display: none;
      /* hidden by default */
    }

    .tab-content.active {
      display: block;
    }

    /* ================================
            SAVED TAB
            ================================ */
    .saved-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1rem;
    }

    .saved-logo {
      margin-left: 35px;
      margin-top: 1rem;
      width: 350px;
      height: 200px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: var(--border-radius);
    }

    .saved-logo svg {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
    }

    .quick-links {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 1rem;
      margin: 1rem 0;
    }

    .quick-link {
      width: 80px;
      text-align: center;
      border-radius: var(--border-radius);
      background: #333;
      padding: 0.5rem;
      cursor: pointer;
      user-select: none;
      position: relative;
    }

    .quick-link:focus {
      /* outline: 2px solid #888; */

    }

    .quick-link .icon-container {
      width: 40px;
      height: 40px;
      margin: 0 auto;
      border-radius: 50%;
      background: #555;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 0.25rem;
    }

    .quick-link img {
      width: 24;
      max-width: 100%;
      max-height: 100%;
      border-radius: 50%;
    }

    .quick-link .ql-text {
      font-size: 0.75rem;
    }

    .customise-btn {
      margin-top: 1rem;
      background: #444;
    }

    .add-link-btn {
      margin-top: 1rem;
      background: #555;
      display: none;
    }

    .add-link-btn.edit-mode {
      display: block;
    }

    /* Dragging Styles (while in edit mode) */
    .quick-link.dragging {
      opacity: 0.5;
    }

    .drop-zone {
      border: 2px dashed #666;
      margin: 1rem;
      padding: 1rem;
      display: none;
    }

    .drop-zone.edit-mode {
      display: block;
    }

    .quick-link .remove-icon {
      position: absolute;
      top: -5px;
      right: -5px;
      background: #ff4444;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: none;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      cursor: pointer;
      z-index: 5;
    }

    .quick-link.edit-mode .remove-icon {
      display: flex;
    }

    /* Skeleton Loading Animation */
    @keyframes skeleton-loading {
      0% {
        background-color: var(--skeleton-color);
      }

      100% {
        background-color: var(--skeleton-highlight);
      }
    }

    .skeleton {
      border-radius: var(--border-radius);
      animation: skeleton-loading 1s linear infinite alternate;
    }

    /* Skeleton placeholders for quick links (Saved tab) */
    .quick-link.skeleton {
      width: 80px;
      height: 60px;
    }

    /* ================================
            LIVE TAB
            ================================ */
    .live-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 3rem;
    }

    .live-tile {
      background: #333;
      border-radius: var(--border-radius);
      padding: 0.5rem;
      cursor: pointer;
      max-width: 250px;
    }

    .live-tile:focus {
      /* outline: 2px solid #888; */

    }

    .live-tile-img {
      width: 100%;
      height: 100px;
      background: #555;
      margin-bottom: 0.5rem;
      border-radius: var(--border-radius);
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
    }


    .live-tile-img img {
      width: 100%;
      height: auto;
      /* Blur effect */
      filter: blur(10px);
      -webkit-filter: blur(10px);
      /* For Safari */
    }

    .live-tile-img {
      position: relative;
    }

    .live-tile-img .device-info {
      position: absolute;
      top: 5px;
      left: 5px;

      font-size: 12px;
      font-weight: bold;
      color: #ffffff;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 100%;
    }


    .live-tile-title {
      font-size: 0.9rem;
      margin-bottom: 0.25rem;
    }

    .live-tile-meta {
      font-size: 0.7rem;
      color: #aaa;
    }

    .live-tile-img .device-link {
      position: absolute;
      bottom: 5px;
      left: 5px;
      font-size: 12px;
      color: #ffffff;
      opacity: 0.6;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
    }

    /* Skeleton placeholders for Live tab */
    .live-tile.skeleton .live-tile-img {
      animation: skeleton-loading 1s linear infinite alternate;
    }

    .live-tile.skeleton .live-tile-title,
    .live-tile.skeleton .live-tile-meta {
      background: var(--skeleton-color);
      animation: skeleton-loading 1s linear infinite alternate;
    }

    /* ================================
            NOTES TAB
            ================================ */
    .notes-content {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 200px;
      font-size: 1.2rem;
      color: #888;
    }

    /* ================================
            MODAL (for Password)
            ================================ */
    .modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal {
      background: var(--accent-color);
      padding: 1rem;
      border-radius: var(--border-radius);
      display: flex;
      flex-direction: column;
      gap: 1rem;
      width: 300px;
    }

    .modal input {
      width: 100%;
      padding: 0.5rem;
      border-radius: var(--border-radius);
      border: 1px solid #444;
      background: #222;
      color: #fff;
    }

    /* ================================
            EDIT LINK MODAL
            ================================ */
    .edit-link-modal-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1001;
    }

    .edit-link-modal {
      background: var(--accent-color);
      padding: 1rem;
      border-radius: var(--border-radius);
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      width: 350px;
    }

    .edit-link-modal label {
      font-size: 0.9rem;
      margin-top: 0.5rem;
    }

    .edit-link-modal input[type="text"],
    .edit-link-modal input[type="url"] {
      width: 100%;
      padding: 0.5rem;
      border-radius: var(--border-radius);
      border: 1px solid #444;
      background: #222;
      color: #fff;
    }

    .edit-link-modal .modal-buttons {
      display: flex;
      justify-content: flex-end;
      gap: 0.5rem;
      margin-top: 1rem;
    }
  </style>
</head>

<body>

  <div class="app-container">

    <div class="tabs">
      <br />
      <button id="savedbtn" class="tab-button active" data-tab="saved" tabindex="2">Saved</button>
      <button id="livebtn" class="tab-button" data-tab="live" tabindex="3">Live</button>
      <button id="notesbtn" class="tab-button" data-tab="notes" tabindex="4">Notes</button>
      <br />
    </div>

    <div class="tab-content active" id="savedTab">
      <div class="saved-content">
        <div class="saved-logo" id="savedLogo" tabindex="-1">

        </div>

        <div class="quick-links" id="quickLinks">
        </div>

        <div class="drop-zone" id="dropZone">
          <p>Drag & drop to reorder your links</p>
        </div>

        <button class="customise-btn" id="customiseBtn" tabindex="">
          <span class="material-symbols-outlined" style="vertical-align:middle;">edit</span>
          Customise
        </button>

        <button class="add-link-btn" id="addLinkBtn">
          <span class="material-symbols-outlined" style="vertical-align:middle;">add</span>
          Add Link
        </button>
      </div>
    </div>

    <div class="tab-content" id="liveTab">
      <div class="live-grid" id="liveGrid">
      </div>
    </div>

    <div class="tab-content" id="notesTab">
      <div class="notes-content">
        Under development...
      </div>
    </div>

  </div>

  <div class="modal-backdrop" id="passwordModal" style="display: none;">
    <div class="modal">
      <h3>Enter Password</h3>
      <form onsubmit="passwordSubmission(event)">
        <input type="password" id="passwordField" />
        <button id="passwordSubmitBtn">Submit</button>
      </form>
    </div>
  </div>

  <div class="edit-link-modal-backdrop" id="editLinkModal" style="display: none;">
    <div class="edit-link-modal">
      <h3>Edit Link</h3>
      <label for="editLinkText">Text:</label>
      <input type="text" id="editLinkText" />
      <label for="editLinkUrl">URL:</label>
      <input type="url" id="editLinkUrl" />
      <div class="modal-buttons">
        <button id="editLinkCancelBtn">Cancel</button>
        <button id="editLinkSaveBtn">Save</button>
      </div>
    </div>
  </div>

  <script>
    /* ===========================================================
        Utility / Mock / Placeholder Functions
        =========================================================== */

    // Import CryptoJS library for AES encryption/decryption
    // Assuming it's included via a <script> tag before this code

    async function encryptData(data, password) {
      if (typeof data !== 'string' || data.trim() === '' ||
        typeof password !== 'string' || password.trim() === '') {
        console.error('Invalid data or password provided for encryption.');
        return;
      }

      try {
        // Convert the password string to an array of bytes
        const textEncoder = new TextEncoder();
        const passwordBytes = textEncoder.encode(password);

        // Derive a cryptographic key from the password
        const passwordKey = await window.crypto.subtle.importKey(
          'raw',
          passwordBytes,
          { name: 'PBKDF2' },
          false,
          ['deriveKey']
        );

        // Derive an AES key
        const aesKey = await window.crypto.subtle.deriveKey(
          {
            name: 'PBKDF2',
            salt: passwordBytes, // Use the password itself as the salt for simplicity
            iterations: 100000,
            hash: 'SHA-256'
          },
          passwordKey,
          { name: 'AES-GCM', length: 256 },
          true,
          ['encrypt', 'decrypt']
        );

        // Generate a random initialization vector (IV)
        const iv = window.crypto.getRandomValues(new Uint8Array(12));

        // Encrypt the data
        const dataBytes = textEncoder.encode(data);
        const encryptedData = await window.crypto.subtle.encrypt(
          { name: 'AES-GCM', iv },
          aesKey,
          dataBytes
        );

        // Concatenate the IV and encrypted data
        const encryptedArray = new Uint8Array(iv.length + encryptedData.byteLength);
        encryptedArray.set(iv);
        encryptedArray.set(new Uint8Array(encryptedData), iv.length);

        // Convert to Base64 and log the result
        const encryptedString = btoa(String.fromCharCode(...encryptedArray));
        console.log(encryptedString);
        return encryptedString;
      } catch (error) {
        console.error('Encryption failed:', error);
      }
    }

    async function encryptSVG(svgContent, password) {
      if (typeof svgContent !== 'string' || svgContent.trim() === '') {
        console.error('Invalid SVG content provided for encryption.');
        return;
      }
      const encryptedSvg = await encryptData(svgContent, password);
      console.log('Encrypted SVG:', encryptedSvg);
      return encryptedSvg;
    }

    async function decryptData(encryptedData, password) {
      // Check for valid encrypted data and password
      if (typeof encryptedData !== 'string' || encryptedData.trim() === '' ||
        typeof password !== 'string' || password.trim() === '') {
        console.error('Invalid encrypted data or password provided for decryption.');
        return;
      }

      try {
        // Convert the Base64 string back to a Uint8Array
        const encryptedArray = Uint8Array.from(atob(encryptedData), c => c.charCodeAt(0));
        const iv = encryptedArray.slice(0, 12);
        const encryptedBytes = encryptedArray.slice(12);

        // Convert the password string to an array of bytes
        const textEncoder = new TextEncoder();
        const passwordBytes = textEncoder.encode(password);

        // Derive the key
        const passwordKey = await window.crypto.subtle.importKey(
          'raw',
          passwordBytes,
          { name: 'PBKDF2' },
          false,
          ['deriveKey']
        );

        // Derive an AES key
        const aesKey = await window.crypto.subtle.deriveKey(
          {
            name: 'PBKDF2',
            salt: passwordBytes,
            iterations: 100000,
            hash: 'SHA-256'
          },
          passwordKey,
          { name: 'AES-GCM', length: 256 },
          true,
          ['encrypt', 'decrypt']
        );

        // Decrypt the data
        const decryptedData = await window.crypto.subtle.decrypt({ name: 'AES-GCM', iv }, aesKey, encryptedBytes);

        // Convert to string and log the result
        const decryptedString = new TextDecoder().decode(decryptedData);
        //console.log(decryptedString);
        return decryptedString;
      } catch (error) {
        console.error('Decryption failed:', error);
      }
    }

    async function decryptAndPlaceSVG(encryptedSvg, password, elementId) {
      const decryptedSvg = await decryptData(encryptedSvg, password);
      if (decryptedSvg) {
        const svgElement = document.getElementById(elementId);
        if (svgElement) {
          svgElement.innerHTML = decryptedSvg;
        }
      }
    }

    /**
     * Mock function to decrypt the API URL using the password.
     * Replace with your real decryption method.
     */
    function decryptUrl(encryptedUrl, password) {
      // if(decryptData(encryptedUrl, password) == null)
      // return encryptedUrl;
      // else
      // return decryptData(encryptedUrl, password);
      return encryptedUrl;
    }

    /**
     * Simple helper to get URL params by name
     */
    function getUrlParam(name) {
      const params = new URLSearchParams(window.location.search);
      return params.get(name);
    }

    /* ===========================================================
        Password Check & Modal
        =========================================================== */
    const passwordModal = document.getElementById('passwordModal');
    const passwordField = document.getElementById('passwordField');
    const passwordSubmitBtn = document.getElementById('passwordSubmitBtn');

    // Check if password param is in URL
    let password = getUrlParam('password');
    if (!password) {
      // Show modal
      passwordModal.style.display = 'flex';
      setTimeout(() => {
        passwordField.focus();
        passwordModal.tabIndex = 0;
      }, 50);
    } else {
      // We have a password param, proceed
      // decrypt the API URL or do any needed initialization
      initApp();
    }

    passwordSubmitBtn.addEventListener('click', () => {

      passwordSubmission();
    });

    function passwordSubmission(e) {
      try {
        e.preventDefault(); // Prevent page reload
      } catch (error) {
        console.log("Error: " + error);
      }
      const enteredPass = passwordField.value.trim();
      if (enteredPass) {
        // Reload the page with the password param
        const newUrl = new URL(window.location.href);
        newUrl.searchParams.set('password', enteredPass);
        window.location.href = newUrl.toString();
      }
    }

    /* ===========================================================
        Tabs Switching
        =========================================================== */
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');

    tabButtons.forEach(btn => {
      btn.addEventListener('focus', () => {
        // Deactivate all tabs
        tabButtons.forEach(b => b.classList.remove('active'));
        tabContents.forEach(tc => tc.classList.remove('active'));

        // Activate the clicked tab
        btn.classList.add('active');
        const tabName = btn.getAttribute('data-tab');
        document.getElementById(tabName + 'Tab').classList.add('active');
      });
    });

    /* ===========================================================
        DPAD / Key Handling (fast-forward key = 90)
        =========================================================== */
    document.addEventListener('keydown', (e) => {
      if (e.keyCode === 228) {
        // Keycode 90 pressed (Android fast-forward)
        // We can run a special function if an element is focused
        const focused = document.activeElement;
        if (focused && focused.dataset && focused.dataset.link && !editMode) {
          // If the item has a data-link, handle fast-forward action
          handleItemSelect('fastForward', focused.dataset.link);
        }
      }
    });

    /* ===========================================================
        App Initialization after password is found
        =========================================================== */
    var baseURL;
    async function initApp() {
      /*this file will not work unless published to GitHub as we are using it as a raw link*/
      const response = await fetch("https://raw.githubusercontent.com/HappyIf/Connectoweb/refs/heads/main/secrets.json", {

      });

      let params = new URLSearchParams(document.location.search)
      let pass = params.get("password");

      const result = await response.json();
      //const array = JSON.parse(result);

      baseURL = result[0]["api"];
      baseURL = await decryptData(baseURL, pass);
      baseURL = baseURL + pass;

      //console.log(result[0]["logo"]);
      let encryptedSVG = result[0]["logo"];
      await decryptAndPlaceSVG(encryptedSVG, pass, "savedLogo");
      // In real usage, decrypt the actual API endpoint with the password:

      // Start building out the skeletons, then fetch data
      buildSkeletons();

      // Load quick links for Saved tab
      loadQuickLinks();

      // Load Live tab data
      loadLiveLinks(baseURL + "&path=system/live.json");

      document.getElementById("savedbtn").addEventListener("focus", function () {
        buildSkeletons();
        loadQuickLinks();
      });
      document.getElementById("livebtn").addEventListener("focus", function () {
        buildSkeletons();
        loadLiveLinks(baseURL + "&path=system/live.json");
      });
      // document.getElementById("notesbtn").addEventListener("focus", function () {
      //   loadQuickLinks();
      // });
    }

    /* ===========================================================
        Skeleton Builders
        =========================================================== */
    function buildSkeletons() {
      // Saved Tab skeleton (quick links)
      const quickLinksContainer = document.getElementById('quickLinks');
      for (let i = 0; i < 5; i++) {
        const skel = document.createElement('div');
        skel.classList.add('quick-link', 'skeleton');
        quickLinksContainer.appendChild(skel);
      }

      // Live tab skeleton
      const liveGrid = document.getElementById('liveGrid');
      for (let i = 0; i < 6; i++) {
        const tile = document.createElement('div');
        tile.classList.add('live-tile', 'skeleton');

        const imgDiv = document.createElement('div');
        imgDiv.classList.add('live-tile-img');
        tile.appendChild(imgDiv);

        const titleDiv = document.createElement('div');
        titleDiv.classList.add('live-tile-title');
        titleDiv.style.height = '1rem';
        tile.appendChild(titleDiv);

        const metaDiv = document.createElement('div');
        metaDiv.classList.add('live-tile-meta');
        metaDiv.style.height = '0.8rem';
        tile.appendChild(metaDiv);

        liveGrid.appendChild(tile);
      }
    }

    /* ===========================================================
        Loading & Rendering: Saved Tab
        =========================================================== */
    function loadQuickLinks(apiUrl) {
      // Simulate a fetch from your real endpoint
      // setTimeout to simulate network
      setTimeout(() => {
        // Remove skeleton
        const quickLinksContainer = document.getElementById('quickLinks');
        quickLinksContainer.innerHTML = '';

        // Mock data
        const data = [
          { name: 'Google', link: 'https://google.com' },
          { name: 'GitHub', link: 'https://github.com' },
          { name: 'Stack', link: 'https://stackoverflow.com' },
          { name: 'Reddit', link: 'https://reddit.com' },
        ];

        data.forEach((item, index) => {
          renderQuickLink(item, index);
        });
      }, 1000);
    }

    function renderQuickLink(item, index) {
      const quickLinksContainer = document.getElementById('quickLinks');
      const ql = document.createElement('div');
      ql.classList.add('quick-link');
      ql.tabIndex = 5 + index; // set tab index (just an example)
      ql.draggable = false; // will enable in edit mode
      ql.dataset.link = item.link; // store the link for DPAD / fastForward usage

      // Icon container
      const iconCont = document.createElement('div');
      iconCont.classList.add('icon-container');
      const iconImg = document.createElement('img');
      let urlObj = new URL(item.link);
      iconImg.src = `https://t3.gstatic.com/faviconV2?client=SOCIAL&type=FAVICON&fallback_opts=TYPE,SIZE,URL&url=https://${urlObj.hostname}&size=128`;
      iconCont.appendChild(iconImg);

      // Text
      const textDiv = document.createElement('div');
      textDiv.classList.add('ql-text');
      textDiv.textContent = item.name;

      // Remove icon (visible in edit mode)
      const removeIcon = document.createElement('div');
      removeIcon.classList.add('remove-icon');
      removeIcon.innerHTML = '×';
      removeIcon.addEventListener('click', (e) => {
        e.stopPropagation();
        ql.remove();
      });

      // Build structure
      ql.appendChild(iconCont);
      ql.appendChild(textDiv);
      ql.appendChild(removeIcon);

      // Handle normal click
      ql.addEventListener('click', () => {
        if (!editMode) {
          window.location.href = ql.getAttribute('data-link');
          //handleItemSelect('click', item.link);
        }
      });

      quickLinksContainer.appendChild(ql);
    }

    /* ===========================================================
        Loading & Rendering: Live Tab
        =========================================================== */
    /* function loadLiveLinks(apiUrl) {
     
       // Remove skeleton
       const liveGrid = document.getElementById('liveGrid');
       liveGrid.innerHTML = '';
         // get user agent info
 
         // Mock data
         const data = [
           {
             title: 'Cool Article',
             link: 'https://youtube.com',
             device: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/134.0.0.0 Safari/537.36',
             time: '2025-03-28 10:00',
           },
           {
             title: 'Another Link',
             link: 'https://www.instagram.com/p/DHvn5tyyfCnqa_fD5qXxzz0cOAq6GwtNCqc01E0/',
             device: 'Mozilla/5.0 (Linux; Android 12; ) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/103.0.5060.53 Safari/537.36',
             time: '2025-03-28 09:55',
           },
           {
             title: 'Firetv Link',
             link: 'https://amazon.com/',
             device: 'Mozilla/5.0 (Linux; Android 9; FTV) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/109.0.0.0 Mobile Safari/537.36',
             time: '2025-03-28 07:55',
           },
           {
             title: 'Windows Link',
             link: 'https://windows.com/',
             device: 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/123.0.0.0 Safari/537.36',
             time: '2025-03-28 09:55',
           },
           {
             title: 'Android Link',
             link: 'https://android.com/',
             device: 'Mozilla/5.0 (Linux; Android 10; K) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/123.0.0.0 Mobile Safari/537.36',
             time: '2025-03-28 09:55',
           },
         ];
 
         data.forEach((item, index) => {
           const tile = document.createElement('div');
           tile.classList.add('live-tile');
           tile.tabIndex = 10 + index;
           tile.dataset.link = item.link;
 
           // Image
           const imgDiv = document.createElement('div');
           imgDiv.classList.add('live-tile-img');
           const ogImg = document.createElement('img');
           let urlObj = new URL(item.link);
           ogImg.src = `https://t3.gstatic.com/faviconV2?client=SOCIAL&type=FAVICON&fallback_opts=TYPE,SIZE,URL&url=https://${urlObj.hostname}&size=128`;
 
           const os = item.device;
 
 
           const deviceInfoDiv = document.createElement("div");
           deviceInfoDiv.classList.add("device-info");
 
           let deviceIcon = "question_mark"; // Default icon
           var str = "";
           if (os.toLowerCase().includes("android") && item.device.includes("FT") && item.device.includes("TV")) {
             str = "TV";
             deviceIcon = "tv"; // Fire TV
           } else if (os.toLowerCase().includes("android")) {
             str = "Android";
             deviceIcon = "smartphone"; // Android
           } else if (os.toLowerCase().includes("windows")) {
             str = "Windows";
             deviceIcon = "desktop_windows";
           }
           deviceInfoDiv.innerHTML = `<span class="material-symbols-outlined">${deviceIcon}</span>
           ${str}`;
           //console.log(str);
           imgDiv.appendChild(ogImg);
           imgDiv.appendChild(deviceInfoDiv);
 
           // Title
           const deviceLinkDiv = document.createElement("div");
           deviceLinkDiv.classList.add("device-link");
           deviceLinkDiv.textContent = item.link;
           imgDiv.appendChild(deviceLinkDiv);
           const titleDiv = document.createElement('div');
           titleDiv.classList.add('live-tile-title');
           titleDiv.textContent = item.title;
 
           // Meta
           const metaDiv = document.createElement('div');
           metaDiv.classList.add('live-tile-meta');
           metaDiv.textContent = `Time: ${item.time}`;
 
           // Build structure
           tile.appendChild(imgDiv);
           tile.appendChild(titleDiv);
           tile.appendChild(metaDiv);
 
           // Handle normal click
           tile.addEventListener('click', () => {
             handleItemSelect('click', item.link);
           });
 
           liveGrid.appendChild(tile);
         });
       
     }*/
    async function loadLiveLinks(apiUrl) {
      try {
        const response = await fetch(apiUrl, {

        });

        const result = await response.json();

        // Parse message field as JSON
        let data;
        try {
          data = JSON.parse(result.message.replace(/\r?\n/g, ''));
        } catch (error) {
          console.error("Error parsing message JSON:", error);
          return;
        }

        // Remove skeleton
        const liveGrid = document.getElementById('liveGrid');
        liveGrid.innerHTML = '';

        data.forEach((item, index) => {
          const tile = document.createElement('div');
          tile.classList.add('live-tile');
          tile.tabIndex = 10 + index;
          tile.dataset.link = item.link;

          // Image
          const imgDiv = document.createElement('div');
          imgDiv.classList.add('live-tile-img');
          const ogImg = document.createElement('img');
          let urlObj = new URL(item.link.trim());
          ogImg.src = `https://t3.gstatic.com/faviconV2?client=SOCIAL&type=FAVICON&fallback_opts=TYPE,SIZE,URL&url=https://${urlObj.hostname}&size=128`;

          // Determine device type
          const os = item.device;
          const deviceInfoDiv = document.createElement("div");
          deviceInfoDiv.classList.add("device-info");
          let deviceIcon = "question_mark";
          let str = "";

          if (os.toLowerCase().includes("android") && os.includes("FT") && os.includes("TV")) {
            str = "TV";
            deviceIcon = "tv";
          } else if (os.toLowerCase().includes("android")) {
            str = "Android";
            deviceIcon = "smartphone";
          } else if (os.toLowerCase().includes("windows")) {
            str = "Windows";
            deviceIcon = "desktop_windows";
          }
          deviceInfoDiv.innerHTML = `<span class="material-symbols-outlined">${deviceIcon}</span> ${str}`;
          imgDiv.appendChild(ogImg);
          imgDiv.appendChild(deviceInfoDiv);

          // Link Display
          const deviceLinkDiv = document.createElement("div");
          deviceLinkDiv.classList.add("device-link");
          deviceLinkDiv.textContent = item.link.trim();
          imgDiv.appendChild(deviceLinkDiv);

          // Title
          const titleDiv = document.createElement('div');
          titleDiv.classList.add('live-tile-title');
          titleDiv.textContent = item.title;

          // Meta Info
          const metaDiv = document.createElement('div');
          metaDiv.classList.add('live-tile-meta');
          metaDiv.textContent = `Time: ${item.time}`;

          // Build structure
          tile.appendChild(imgDiv);
          tile.appendChild(titleDiv);
          tile.appendChild(metaDiv);

          // Handle Click
          tile.addEventListener('click', () => {
            handleItemSelect('click', item.link.trim());
          });

          liveGrid.appendChild(tile);
        });
      } catch (error) {
        console.error("Error loading live links:", error);
      }
    }


    /* ===========================================================
        Handling Click vs FastForward
        =========================================================== */

    // Call function with API URL
    // loadLiveLinks("https://api.com/getrequest");

    function handleItemSelect(eventType, link) {
      if (eventType === 'click') {
        // Normal click -> open link
        window.open(link, '_blank');
      } else if (eventType === 'fastForward') {
        // Fast-forward key pressed -> do something else
        console.log('Fast-forward event on link:', link);
        // e.g. show a context menu, or load preview, etc.
        alert('Fast-forward key event triggered for ' + link);
      }
    }

    // document.addEventListener("keydown", function (event) {
    //   //alert(`Key pressed: ${event.key}, KeyCode: ${event.keyCode}`);
    //   // MediaFastForward, keyCode: 228
    // });

    /* ===========================================================
        Edit / Customize Mode for Quick Links
        =========================================================== */
    const customiseBtn = document.getElementById('customiseBtn');
    const addLinkBtn = document.getElementById('addLinkBtn');
    const quickLinksContainer = document.getElementById('quickLinks');
    const dropZone = document.getElementById('dropZone');
    const editLinkModal = document.getElementById('editLinkModal');
    const editLinkText = document.getElementById('editLinkText');
    const editLinkUrl = document.getElementById('editLinkUrl');
    const editLinkCancelBtn = document.getElementById('editLinkCancelBtn');
    const editLinkSaveBtn = document.getElementById('editLinkSaveBtn');

    let editMode = false;
    let draggedItem = null;
    let originalTabIndices = {};
    let currentEditingLink = null;

    customiseBtn.addEventListener('click', () => {
      editMode = !editMode;
      if (editMode) {
        customiseBtn.innerHTML = '<span class="material-symbols-outlined" style="vertical-align:middle;">check</span> Done';
        enableEditMode();
      } else {
        customiseBtn.innerHTML = '<span class="material-symbols-outlined" style="vertical-align:middle;">edit</span> Customise';
        disableEditMode();
        // TODO: POST updated order to API, if needed
      }
    });

    addLinkBtn.addEventListener('click', () => {
      // Mock adding a new link
      const newLink = {
        name: 'New Link',
        link: 'https://example.com/new',
        icon: 'https://via.placeholder.com/32?text=New'
      };
      renderQuickLink(newLink, document.querySelectorAll('.quick-link').length);

      // Make sure the new link is properly set up for edit mode
      const newElement = quickLinksContainer.lastElementChild;
      newElement.draggable = true;
      newElement.style.cursor = 'grab';
      newElement.classList.add('edit-mode');
      setupDragEvents(newElement);
      setupDoubleClickEdit(newElement); // Add double-click listener for the new element
    });

    function enableEditMode() {
      // Store original tabindex values
      originalTabIndices = {};
      document.querySelectorAll('[tabindex]').forEach(el => {
        originalTabIndices[el.getAttribute('tabindex')] = el;
        el.setAttribute('tabindex', -1); // Remove tabindex during edit
      });

      // Show dropZone or any instructions
      dropZone.classList.add('edit-mode');
      addLinkBtn.classList.add('edit-mode');

      // Make quick-links draggable and add edit mode styles
      Array.from(quickLinksContainer.children).forEach(linkEl => {
        linkEl.draggable = true;
        linkEl.style.cursor = 'grab';
        linkEl.classList.add('edit-mode');
        setupDragEvents(linkEl);
        setupDoubleClickEdit(linkEl); // Add double-click listener
      });

      // Add dragover listener to the container
      quickLinksContainer.addEventListener('dragover', handleContainerDragOver);
    }

    function setupDragEvents(linkEl) {
      linkEl.addEventListener('dragstart', onDragStart);
      linkEl.addEventListener('dragend', onDragEnd);
    }

    function disableEditMode() {
      dropZone.classList.remove('edit-mode');
      addLinkBtn.classList.remove('edit-mode');

      // Remove edit mode from links
      Array.from(quickLinksContainer.children).forEach(linkEl => {
        linkEl.draggable = false;
        linkEl.style.cursor = 'pointer';
        linkEl.classList.remove('edit-mode');
        linkEl.removeEventListener('dragstart', onDragStart);
        linkEl.removeEventListener('dragend', onDragEnd);
        linkEl.removeEventListener('dblclick', openEditLinkModal); // Remove double-click listener
      });

      // Remove container listeners
      quickLinksContainer.removeEventListener('dragover', handleContainerDragOver);

      // Reassign tabindex
      Object.keys(originalTabIndices).forEach(index => {
        originalTabIndices[index].setAttribute('tabindex', index);
      });
      originalTabIndices = {}; // Clear stored indices

      //log data array
      const data = Array.from(quickLinksContainer.children).map(linkEl => {
        return {
          name: linkEl.querySelector('.ql-text').textContent,
          link: linkEl.dataset.link
        };
      });

      console.log(JSON.stringify(data, null, 2));


      // Call the function to apply tabindex
      setTabIndexForQuickLinks();
    }

    function setTabIndexForQuickLinks() {
      const quickLinks = document.querySelectorAll('.quick-link');

      quickLinks.forEach((element, index) => {
        element.tabIndex = 4 + index;
      });
    }


    function onDragStart(e) {
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/plain', null); // Required for Firefox

      draggedItem = this;
      this.classList.add('dragging');

      // Small delay so the dragging visual effect works
      setTimeout(() => {
        this.style.opacity = '0.5';
      }, 0);
    }

    function onDragEnd(e) {
      this.style.opacity = '1';
      this.classList.remove('dragging');
      draggedItem = null;

      // Remove any temporary placeholders
      const placeholders = document.querySelectorAll('.placeholder');
      placeholders.forEach(el => el.remove());
    }

    function handleContainerDragOver(e) {
      e.preventDefault();
      e.stopPropagation();

      if (!draggedItem) return;

      // Get the element under the cursor
      const afterElement = getDragAfterElement(quickLinksContainer, e.clientX, e.clientY);

      if (afterElement === null) {
        quickLinksContainer.appendChild(draggedItem);
      } else if (afterElement !== draggedItem) {
        quickLinksContainer.insertBefore(draggedItem, afterElement);
      }
    }

    /**
     * Helper to figure out the correct place to drop the dragged item.
     * Fixed to work with any element position, not just start/end.
     */
    function getDragAfterElement(container, x, y) {
      // Get all the draggable elements that aren't currently being dragged
      const draggableElements = [...container.querySelectorAll('.quick-link:not(.dragging)')];

      // Find the closest element based on mouse position
      return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const centerX = box.left + box.width / 2;
        const centerY = box.top + box.height / 2;

        // Calculate distance from mouse to center of element
        const offsetX = x - centerX;
        const offsetY = y - centerY;
        const distance = Math.sqrt(offsetX * offsetX + offsetY * offsetY);

        // Return the closest element
        return (distance < closest.distance) ?
          { distance: distance, element: child } :
          closest;
      }, { distance: Number.POSITIVE_INFINITY }).element;
    }

    /* ===========================================================
        Edit Link Modal Functionality
        =========================================================== */
    function setupDoubleClickEdit(linkElement) {
      linkElement.addEventListener('dblclick', openEditLinkModal);
    }

    function openEditLinkModal(e) {
      if (!editMode) return;

      currentEditingLink = e.currentTarget;
      const textElement = currentEditingLink.querySelector('.ql-text');
      const linkUrl = currentEditingLink.dataset.link;

      editLinkText.value = textElement ? textElement.textContent : '';
      editLinkUrl.value = linkUrl;

      editLinkModal.style.display = 'flex';
    }

    editLinkCancelBtn.addEventListener('click', () => {
      editLinkModal.style.display = 'none';
      currentEditingLink = null;
    });

    editLinkSaveBtn.addEventListener('click', () => {
      if (!currentEditingLink) return;

      const newText = editLinkText.value.trim();
      const newUrl = editLinkUrl.value.trim();

      const textElement = currentEditingLink.querySelector('.ql-text');
      if (textElement) {
        textElement.textContent = newText;
      }
      currentEditingLink.dataset.link = newUrl;

      // Update the favicon (basic implementation, might need refinement)
      const iconImg = currentEditingLink.querySelector('.icon-container img');
      if (iconImg) {
        try {
          let urlObj = new URL(newUrl);
          iconImg.src = `https://t3.gstatic.com/faviconV2?client=SOCIAL&type=FAVICON&fallback_opts=TYPE,SIZE,URL&url=https://${urlObj.hostname}&size=128`;
        } catch (error) {
          console.error("Invalid URL:", newUrl);
          // Optionally set a default icon or handle the error
        }
      }

      editLinkModal.style.display = 'none';
      currentEditingLink = null;
    });

    // Close modal if clicked outside
    window.addEventListener('click', (event) => {
      if (event.target === editLinkModal) {
        editLinkModal.style.display = 'none';
        currentEditingLink = null;
      }
    });
  </script>
</body>

</html>
